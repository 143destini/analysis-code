# ==== 1. å¯¼å…¥åŸºç¡€åº“ ====
import argparse
import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split
from sklearn.metrics import r2_score, mean_squared_error, mean_absolute_error
import shap

# å­—ä½“è®¾ç½®ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
plt.rcParams['font.sans-serif'] = ['SimHei']
plt.rcParams['axes.unicode_minus'] = False


# ==== 2. ä¸»å‡½æ•° ====
def main(input_path, target_col, output_dir):
    # ---------- è¯»å–æ•°æ® ----------
    print(f"ğŸ“˜ æ­£åœ¨è¯»å–æ•°æ®æ–‡ä»¶ï¼š{input_path}")
    if input_path.endswith(".xlsx") or input_path.endswith(".xls"):
        df = pd.read_excel(input_path)
    elif input_path.endswith(".csv"):
        df = pd.read_csv(input_path)
    else:
        raise ValueError(" ä»…æ”¯æŒ Excel æˆ– CSV æ–‡ä»¶ï¼")

    print(f"æ•°æ®è¯»å–æˆåŠŸï¼Œç»´åº¦ï¼š{df.shape}")

    # ---------- ç‰¹å¾ä¸ç›®æ ‡ ----------
    if target_col not in df.columns:
        raise ValueError(f" ç›®æ ‡åˆ— '{target_col}' ä¸å­˜åœ¨ï¼å¯é€‰åˆ—æœ‰ï¼š{list(df.columns)}")

    X = df.drop(columns=[target_col])
    y = df[target_col]

    # ä¿ç•™æ•°å€¼å‹å˜é‡
    X = X.select_dtypes(include=[np.number])
    print(f"æ•°å€¼ç‰¹å¾æ•°ï¼š{X.shape[1]}")

    # ---------- æ•°æ®é›†åˆ’åˆ† ----------
    X_temp, X_test, y_temp, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
    X_train, X_val, y_train, y_val = train_test_split(X_temp, y_temp, test_size=0.125, random_state=24)

    # ---------- æ ‡å‡†åŒ– ----------
    x_mean, x_std = X_train.mean(), X_train.std()
    y_mean, y_std = y.mean(), y.std()
    X_train = (X_train - x_mean) / x_std
    X_val = (X_val - x_mean) / x_std
    X_test = (X_test - x_mean) / x_std
    y_train = (y_train - y_mean) / y_std
    y_val = (y_val - y_mean) / y_std
    y_test = (y_test - y_mean) / y_std

    # ---------- æ„å»ºæ¨¡å‹ ----------
    model_rf = RandomForestRegressor(
        n_estimators=200,
        max_depth=None,
        random_state=42,
        n_jobs=-1
    )
    print("ğŸš€ æ¨¡å‹å¼€å§‹è®­ç»ƒ...")
    model_rf.fit(X_train, y_train)

    # ---------- é¢„æµ‹ ----------
    pred_train = model_rf.predict(X_train)
    pred_val = model_rf.predict(X_val)
    pred_test = model_rf.predict(X_test)

    # ---------- åæ ‡å‡†åŒ– ----------
    y_train_h = y_train * y_std + y_mean
    y_val_h = y_val * y_std + y_mean
    y_test_h = y_test * y_std + y_mean
    pred_train_h = pred_train * y_std + y_mean
    pred_val_h = pred_val * y_std + y_mean
    pred_test_h = pred_test * y_std + y_mean

    # ---------- æ€§èƒ½è¯„ä¼° ----------
    def print_metrics(y_true, y_pred, dataset_name="æ•°æ®é›†"):
        r2 = r2_score(y_true, y_pred)
        rmse = np.sqrt(mean_squared_error(y_true, y_pred))
        mae = mean_absolute_error(y_true, y_pred)
        print(f"\n {dataset_name}æŒ‡æ ‡:")
        print(f"  RÂ² = {r2:.3f}")
        print(f"  RMSE = {rmse:.3f}")
        print(f"  MAE = {mae:.3f}")
        return {"R2": r2, "RMSE": rmse, "MAE": mae}

    metrics = {
        "Train": print_metrics(y_train_h, pred_train_h, "è®­ç»ƒé›†"),
        "Validation": print_metrics(y_val_h, pred_val_h, "éªŒè¯é›†"),
        "Test": print_metrics(y_test_h, pred_test_h, "æµ‹è¯•é›†")
    }

    # ---------- ç»˜åˆ¶çœŸå® vs é¢„æµ‹ ----------
    def plot_pred_vs_true(y_true, y_pred, dataset_name, color):
        r2 = r2_score(y_true, y_pred)
        rmse = np.sqrt(mean_squared_error(y_true, y_pred))
        mae = mean_absolute_error(y_true, y_pred)
        plt.scatter(y_true, y_pred, alpha=0.3, color=color, label=f'{dataset_name}')
        plt.xlabel('çœŸå®å€¼')
        plt.ylabel('é¢„æµ‹å€¼')
        plt.title(f'{dataset_name}ï¼šRÂ²={r2:.3f}, RMSE={rmse:.3f}, MAE={mae:.3f}')
        plt.legend()
        min_val, max_val = min(y_true.min(), y_pred.min()), max(y_true.max(), y_pred.max())
        plt.plot([min_val, max_val], [min_val, max_val], 'k--', alpha=0.5)

    plt.figure(figsize=(15, 15), dpi=300)
    colors = sns.color_palette("husl", 3)
    plt.subplot(3, 1, 1)
    plot_pred_vs_true(y_train_h, pred_train_h, "è®­ç»ƒé›†", colors[0])
    plt.subplot(3, 1, 2)
    plot_pred_vs_true(y_val_h, pred_val_h, "éªŒè¯é›†", colors[1])
    plt.subplot(3, 1, 3)
    plot_pred_vs_true(y_test_h, pred_test_h, "æµ‹è¯•é›†", colors[2])
    plt.tight_layout()

    scatter_path = os.path.join(output_dir, f"{target_col}_é¢„æµ‹å¯¹æ¯”å›¾.png")
    plt.savefig(scatter_path, dpi=300)
    plt.close()
    print(f" é¢„æµ‹å¯¹æ¯”å›¾å·²ä¿å­˜åˆ°ï¼š{scatter_path}")

    # ---------- SHAP åˆ†æ ----------
    print(" æ­£åœ¨è®¡ç®— SHAP å€¼ï¼ˆå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼‰...")
    explainer = shap.TreeExplainer(model_rf)
    shap_values_test = explainer.shap_values(X_test)

    # ç‚¹å›¾
    shap.summary_plot(shap_values_test, X_test, feature_names=X_test.columns, plot_type="dot", show=False)
    dot_path = os.path.join(output_dir, f"{target_col}_SHAP_dot.png")
    plt.savefig(dot_path, dpi=300, bbox_inches="tight")
    plt.close()

    # æŸ±çŠ¶å›¾
    shap.summary_plot(shap_values_test, X_test, plot_type="bar", show=False)
    bar_path = os.path.join(output_dir, f"{target_col}_SHAP_bar.png")
    plt.savefig(bar_path, dpi=300, bbox_inches="tight")
    plt.close()

    print(f" SHAP å›¾å·²ä¿å­˜åˆ°ï¼š{dot_path} å’Œ {bar_path}")

    # ---------- ä¿å­˜æŒ‡æ ‡ ----------
    metric_df = pd.DataFrame(metrics).T
    metric_path = os.path.join(output_dir, f"{target_col}_æ¨¡å‹è¯„ä¼°æŒ‡æ ‡.xlsx")
    metric_df.to_excel(metric_path)
    print(f"ğŸ“„ æ¨¡å‹è¯„ä¼°æŒ‡æ ‡å·²ä¿å­˜åˆ°ï¼š{metric_path}")

    print("\n å…¨éƒ¨åˆ†æå®Œæˆï¼ç»“æœå·²è¾“å‡ºè‡³ï¼š", output_dir)


# ==== 3. å‚æ•°æ¥å£ ====
if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="é€šç”¨éšæœºæ£®æ—å›å½’ + SHAP è§£é‡Š")
    parser.add_argument("--input", required=True, help="è¾“å…¥æ–‡ä»¶è·¯å¾„ï¼ˆExcel æˆ– CSVï¼‰")
    parser.add_argument("--target", required=True, help="ç›®æ ‡åˆ—åï¼ˆå›å½’é¢„æµ‹å˜é‡ï¼‰")
    parser.add_argument("--output_dir", required=True, help="è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„")
    args = parser.parse_args()

    os.makedirs(args.output_dir, exist_ok=True)
    main(args.input, args.target, args.output_dir)
