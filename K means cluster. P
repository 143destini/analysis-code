import argparse
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from scipy.spatial.distance import cdist
import os


def main(input_path, output_path, k):
    # ========== 1. è¯»å–æ•°æ® ==========
    data = pd.read_csv(input_path, index_col=0)
    print(f"âœ… è¯»å–æ•°æ®æˆåŠŸï¼š{data.shape[0]} è¡Œï¼Œ{data.shape[1]} åˆ—")
    print(data.head())

    # ========== 2. log è½¬æ¢ ==========
    data["Oxidation_log"] = np.log1p(data["Oxidation"])

    # ========== 3. æ•°æ®æ ‡å‡†åŒ– ==========
    scaler = StandardScaler()
    x = scaler.fit_transform(data[["Oxidation_log"]])
    x = pd.DataFrame(x, index=data.index, columns=["Oxidation_log"])

    # ========== 4. æ‰‹è‚˜æ³•ç¡®å®šæœ€ä¼˜ K ==========
    distortions = []
    K = range(1, 10)
    for i in K:
        model = KMeans(n_clusters=i, random_state=42, n_init=10).fit(x)
        distortions.append(
            sum(np.min(cdist(x, model.cluster_centers_, "euclidean"), axis=1)) / x.shape[0]
        )

    plt.figure(figsize=(8, 5))
    plt.plot(K, distortions, "bx-")
    plt.xlabel("Number of Clusters (K)")
    plt.ylabel("Average Distortion")
    plt.title("Elbow Method for Optimal K (log-transformed)")
    plt.grid(True, linestyle="--", alpha=0.5)
    plt.tight_layout()

    elbow_plot_path = os.path.splitext(output_path)[0] + "_elbow.png"
    plt.savefig(elbow_plot_path, dpi=300)
    plt.close()
    print(f"ğŸ“ˆ æ‰‹è‚˜å›¾å·²ä¿å­˜åˆ°: {elbow_plot_path}")

    # ========== 5. èšç±» ==========
    print(f"ğŸ”¹ ä½¿ç”¨ K = {k} è¿›è¡Œèšç±»...")
    kmeans = KMeans(n_clusters=k, random_state=42, n_init=10)
    labels = kmeans.fit_predict(x)

    data["Cluster"] = labels

    # ========== 6. å¯è§†åŒ–èšç±»ç»“æœ ==========
    plt.figure(figsize=(8, 5))
    plt.scatter(data.index, data["Oxidation_log"], c=labels, cmap="Set1", s=30)
    plt.xticks([])
    plt.xlabel("Samples")
    plt.ylabel("Log(Oxidation abundance)")
    plt.title(f"KMeans Clustering (k={k}) on log-transformed data")
    plt.colorbar(label="Cluster")
    plt.tight_layout()

    cluster_plot_path = os.path.splitext(output_path)[0] + "_cluster.png"
    plt.savefig(cluster_plot_path, dpi=300)
    plt.close()
    print(f"ğŸ¨ èšç±»ç»“æœå›¾å·²ä¿å­˜åˆ°: {cluster_plot_path}")

    # ========== 7. ä¿å­˜ç»“æœ ==========
    data.to_csv(output_path, encoding="utf-8-sig")
    print(f"âœ… èšç±»å®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ°: {output_path}")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="æ°§åŒ–ä¸°åº¦èšç±»åˆ†æ")
    parser.add_argument("--input", required=True, help="è¾“å…¥ CSV æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--output", required=True, help="è¾“å‡ºç»“æœ CSV æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--k", type=int, default=2, help="èšç±»æ•°ï¼ˆé»˜è®¤ 2ï¼‰")
    args = parser.parse_args()

    main(args.input, args.output, args.k)
